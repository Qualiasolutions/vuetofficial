FROM python:3.10

ARG AWS_ACCESS_KEY_ID
ARG AWS_SECRET_ACCESS_KEY
ARG DJANGO_SECRET_KEY
ARG POSTGRES_PASSWORD
ARG POSTGRES_USER
ARG POSTGRES_HOST
ARG EMAIL_HOST_PASSWORD
ARG TWILIO_ACCOUNT_SID
ARG TWILIO_AUTH_TOKEN
ARG TWILIO_FROM_NUMBER
ARG ENV

ENV AWS_ACCESS_KEY_ID $AWS_ACCESS_KEY_ID
ENV AWS_SECRET_ACCESS_KEY $AWS_SECRET_ACCESS_KEY
ENV DJANGO_SECRET_KEY $DJANGO_SECRET_KEY
ENV POSTGRES_PASSWORD $POSTGRES_PASSWORD
ENV POSTGRES_USER $POSTGRES_USER
ENV POSTGRES_HOST $POSTGRES_HOST
ENV EMAIL_HOST_PASSWORD $EMAIL_HOST_PASSWORD
ENV TWILIO_ACCOUNT_SID $TWILIO_ACCOUNT_SID
ENV TWILIO_AUTH_TOKEN $TWILIO_AUTH_TOKEN
ENV TWILIO_FROM_NUMBER $TWILIO_FROM_NUMBER
ENV ENV $ENV

RUN apt-get update && \
    apt-get install -y build-essential \
                    python3-dev

COPY . app

RUN pip3 install uwsgi && \
    pip3 install -r app/requirements.txt

RUN mkdir /var/log/uwsgi
RUN touch /var/log/uwsgi/api.log

RUN mkdir /static

WORKDIR /app

RUN python3 manage.py collectstatic

EXPOSE 8000
EXPOSE 5432

CMD ["sh", "/app/start.sh"]