import { StyleSheet } from 'react-native';
import { useNavigation } from '@react-navigation/native';
import SafePressable from './SafePressable';
import { TransparentView, WhitePaddedView } from './ViewComponents';
import { elevation } from 'styles/elevation';
import useGetUserFullDetails from 'hooks/useGetUserDetails';
import { parsePresignedUrl } from 'utils/urls';
import { Image } from './ImageComponents';
import { Text, useThemeColor, View } from 'components/Themed';
import { Feather } from '@expo/vector-icons';
import { BottomTabNavigationProp } from '@react-navigation/bottom-tabs';
import { RootTabParamList } from 'types/base';
import { TouchableOpacity } from './TouchableOpacityComponents';
import { useTranslation } from 'react-i18next';
import { useSelector } from 'react-redux';
import { selectHasUnreadAlert } from 'reduxStore/slices/alerts/selectors';
import { selectFilteredOverdueTasks } from 'reduxStore/slices/tasks/selectors';
import { selectHasUnseenActivity } from 'reduxStore/slices/misc/selectors';

const styles = StyleSheet.create({
  container: {
    paddingVertical: 20,
    justifyContent: 'space-between',
    overflow: 'visible',
    flexDirection: 'row',
    alignItems: 'center',
    marginBottom: 3
  },
  rightButtons: {
    flexDirection: 'row',
    paddingRight: 10,
    paddingTop: 10
  },
  myAccountSize: {
    height: 50,
    width: 50,
    borderRadius: 15
  },
  drawerPressable: {
    justifyContent: 'center',
    alignItems: 'center',
    overflow: 'visible'
  },
  myAccountNullImage: {
    height: 24,
    width: 24
  },
  button: {
    marginLeft: 20,
    alignItems: 'center'
  },
  buttonText: {
    fontSize: 11
  },
  linkMarker: {
    position: 'absolute',
    width: 12,
    height: 12,
    top: 0,
    right: -4,
    backgroundColor: 'red',
    borderRadius: 6,
    borderWidth: 1,
    borderColor: 'brown'
  }
});

const PageLink = ({
  pageName,
  iconName,
  title,
  marked
}: {
  pageName: keyof RootTabParamList;
  iconName: keyof typeof Feather.glyphMap;
  title: string;
  marked?: boolean;
}) => {
  const navigation = useNavigation<BottomTabNavigationProp<RootTabParamList>>();
  const primaryColor = useThemeColor({}, 'primary');

  return (
    <TouchableOpacity
      onPress={() => {
        navigation.navigate(pageName);
      }}
      style={styles.button}
    >
      <Feather name={iconName} size={32} color={primaryColor} />
      <Text style={[styles.buttonText, { color: primaryColor }]}>{title}</Text>
      {marked && <View style={styles.linkMarker} />}
    </TouchableOpacity>
  );
};

export default function TopNav() {
  const navigation = useNavigation<BottomTabNavigationProp<RootTabParamList>>();
  const primaryColor = useThemeColor({}, 'primary');
  const { t } = useTranslation();
  const hasUnreadAlert = useSelector(selectHasUnreadAlert);
  const overdueTasks = useSelector(selectFilteredOverdueTasks);
  const hasUnseenActivity = useSelector(selectHasUnseenActivity);

  return (
    <WhitePaddedView style={[styles.container, elevation.elevated]}>
      <TouchableOpacity onPress={() => (navigation as any).openDrawer()}>
        <Feather name="align-justify" size={32} color={primaryColor} />
      </TouchableOpacity>
      <TransparentView style={styles.rightButtons}>
        <PageLink
          pageName="Alerts"
          iconName="alert-triangle"
          title={t('pageTitles.alerts')}
          marked={hasUnreadAlert}
        />
        <PageLink
          pageName="NewItems"
          iconName="bell"
          title={t('pageTitles.newItems')}
          marked={hasUnseenActivity}
        />
        <PageLink
          pageName="QuickJot"
          iconName="edit"
          title={t('pageTitles.quickJot')}
        />
        <PageLink
          pageName="OverdueTasks"
          iconName="flag"
          title={t('pageTitles.overdue')}
          marked={overdueTasks && overdueTasks.length > 0}
        />
      </TransparentView>
    </WhitePaddedView>
  );
}
